import{u as T,a as d,b as q,j as e,H as M,r as b}from"./app-C70Abe0W.js";import{D as O,X as R}from"./DashboardLayout-8rtCQFVU.js";import{C as x,b as h,c as u,a as g}from"./card-BTIRbnZg.js";import{B as S}from"./button-B4Y0xaOj.js";import{I as p}from"./input-Bs6uNltf.js";import{s as l}from"./use-toast-CTaqu0GZ.js";import{C as U}from"./combobox-CxQqpy9T.js";import{A as z}from"./arrow-left-CwJtPsZh.js";import{U as K}from"./upload-cxb2XaSV.js";import{S as V}from"./save-DzLqkQqm.js";/* empty css            */import"./createLucideIcon-CekqwaTN.js";import"./triangle-alert-BCnpIywG.js";import"./file-text-DAs24fQX.js";import"./eye-pG0WJNoF.js";import"./user-Czo5kvKo.js";import"./dialog-CF0nDsg2.js";import"./index-B6cwgj4L.js";import"./check-C6qQxAeq.js";function xe({contract:y,contracts:v}){const{flash:o}=T().props,[s,A]=d.useState(y||null),[F,N]=d.useState(null),[k,_]=d.useState(null),t=q({contract_id:y?.id||"",payment_method:"cash",payment_date:new Date().toISOString().split("T")[0],amount:"",check_number:"",bank_name:"",check_date:"",notes:""});d.useEffect(()=>{o?.success&&l.success("نجح",o.success),o?.error&&l.error("خطأ",o.error)},[o]),d.useEffect(()=>{s&&(t.setData("contract_id",s.id),(!t.data.amount||t.data.amount==="0")&&t.setData("amount",s.remainingAmount.toString()))},[s]);const $=a=>{const r=v.find(n=>n.id.toString()===a);r&&(A(r),t.setData("contract_id",r.id),t.setData("amount",r.remainingAmount.toString()))},B=a=>{const r=a.target.files?.[0];if(r){if(r.size>10*1024*1024){l.error("خطأ","حجم الملف يجب أن يكون أقل من 10MB");return}N(r);const n=new FileReader;n.onloadend=()=>{_(n.result)},n.readAsDataURL(r)}},I=()=>{N(null),_(null)},E=a=>{if(a.preventDefault(),!s){l.error("خطأ","يرجى اختيار عقد");return}if(parseFloat(t.data.amount)>s.remainingAmount){l.error("خطأ",`المبلغ المدخل يتجاوز المبلغ المتبقي (${s.remainingAmount.toFixed(2)} ر.ع)`);return}if(parseFloat(t.data.amount)<=0){l.error("خطأ","المبلغ يجب أن يكون أكبر من صفر");return}t.setData("check_image",F),t.post("/payments",{forceFormData:!0,onSuccess:()=>{b.visit("/payments")},onError:r=>{const n=[],m={contract_id:"العقد",payment_method:"طريقة الدفع",payment_date:"تاريخ الدفع",amount:"المبلغ",check_number:"رقم الشيك",bank_name:"البنك",check_date:"تاريخ الشيك",check_image:"صورة الشيك"},w=(C,D="")=>{Object.keys(C).forEach(c=>{const j=D?`${D}.${c}`:c,i=C[c];if(Array.isArray(i))i.forEach(f=>{const L=m[c]||m[j]||c;n.push(`${L}: ${f}`)});else if(typeof i=="string"){const f=m[c]||m[j]||c;n.push(`${f}: ${i}`)}else i&&typeof i=="object"&&w(i,j)})};w(r),n.length>0?l.error("خطأ في التسديد",n[0]):l.error("خطأ في التسديد","يرجى التحقق من البيانات المدخلة")}})},P=v.map(a=>({value:a.id.toString(),label:`${a.contractNumber} - ${a.customerName} (متبقي: ${a.remainingAmount.toFixed(2)} ر.ع)`})),H=["بنك مسقط","البنك الوطني العماني","بنك عمان العربي","بنك الإمارات دبي الوطني","بنك HSBC عمان","بنك ستاندرد تشارترد","بنك المشرق","بنك أبوظبي الإسلامي"];return e.jsxs(O,{children:[e.jsx(M,{title:"تسديد دفعة جديدة"}),e.jsxs("div",{className:"space-y-6 pb-8 mt-2 -mx-1 sm:-mx-2 lg:-mx-3 xl:-mx-4",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("button",{onClick:()=>b.visit("/payments"),className:"flex items-center gap-2 text-gray-600 hover:text-gray-800 transition-colors",children:[e.jsx(z,{className:"h-4 w-4"}),"العودة"]}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900 dark:text-white",children:"تسديد دفعة جديدة"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 mt-1",children:"تسديد مبلغ من المتبقي لعقد"})]})]})}),e.jsxs("form",{onSubmit:E,children:[e.jsxs(x,{className:"p-6 mb-6",children:[e.jsx(h,{children:e.jsx(u,{children:"اختيار العقد"})}),e.jsx(g,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"العقد *"}),e.jsx(U,{options:P,value:s?.id.toString()||"",onValueChange:$,placeholder:"اختر العقد...",searchPlaceholder:"ابحث عن عقد...",emptyText:"لا توجد عقود"})]}),s&&e.jsx("div",{className:"bg-gray-50 dark:bg-gray-700 rounded-lg p-4 space-y-2",children:e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"رقم العقد:"}),e.jsx("span",{className:"font-medium text-gray-900 dark:text-white mr-2",children:s.contractNumber})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"العميل:"}),e.jsx("span",{className:"font-medium text-gray-900 dark:text-white mr-2",children:s.customerName})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"المبلغ الإجمالي:"}),e.jsxs("span",{className:"font-medium text-gray-900 dark:text-white mr-2",children:[s.amount.toFixed(2)," ر.ع"]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"المبلغ المدفوع:"}),e.jsxs("span",{className:"font-medium text-green-600 dark:text-green-400 mr-2",children:[s.paidAmount.toFixed(2)," ر.ع"]})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"المبلغ المتبقي:"}),e.jsxs("span",{className:"font-medium text-orange-600 dark:text-orange-400 mr-2 text-lg",children:[s.remainingAmount.toFixed(2)," ر.ع"]})]})]})})]})})]}),e.jsxs(x,{className:"p-6 mb-6",children:[e.jsx(h,{children:e.jsx(u,{children:"معلومات الدفعة"})}),e.jsx(g,{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"طريقة الدفع *"}),e.jsxs("select",{value:t.data.payment_method,onChange:a=>t.setData("payment_method",a.target.value),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#58d2c8] focus:border-transparent bg-white",required:!0,children:[e.jsx("option",{value:"cash",children:"نقداً"}),e.jsx("option",{value:"check",children:"شيك"}),e.jsx("option",{value:"credit_card",children:"بطاقة ائتمان"}),e.jsx("option",{value:"bank_transfer",children:"تحويل بنكي"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"تاريخ الدفع *"}),e.jsx(p,{type:"date",value:t.data.payment_date,onChange:a=>t.setData("payment_date",a.target.value),className:"w-full",dir:"ltr",lang:"en",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"المبلغ (ر.ع) *"}),e.jsx(p,{type:"number",value:t.data.amount,onChange:a=>t.setData("amount",a.target.value),min:"0.01",step:"0.01",max:s?.remainingAmount||void 0,className:"w-full",dir:"ltr",lang:"en",required:!0}),s&&e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["الحد الأقصى: ",s.remainingAmount.toFixed(2)," ر.ع"]})]})]})})]}),t.data.payment_method==="check"&&e.jsxs(x,{className:"p-6 mb-6",children:[e.jsx(h,{children:e.jsx(u,{children:"تفاصيل الشيك"})}),e.jsx(g,{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"رقم الشيك"}),e.jsx(p,{type:"text",value:t.data.check_number,onChange:a=>t.setData("check_number",a.target.value),className:"w-full",dir:"ltr",lang:"en"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"البنك"}),e.jsxs("select",{value:t.data.bank_name,onChange:a=>t.setData("bank_name",a.target.value),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#58d2c8] focus:border-transparent bg-white",children:[e.jsx("option",{value:"",children:"اختر البنك"}),H.map(a=>e.jsx("option",{value:a,children:a},a))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"تاريخ الشيك"}),e.jsx(p,{type:"date",value:t.data.check_date,onChange:a=>t.setData("check_date",a.target.value),className:"w-full",dir:"ltr",lang:"en"})]}),e.jsxs("div",{className:"md:col-span-3",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"صورة الشيك"}),e.jsxs("div",{className:"space-y-3",children:[k?e.jsxs("div",{className:"relative inline-block",children:[e.jsx("img",{src:k,alt:"صورة الشيك",className:"h-32 w-auto rounded-lg border border-gray-300"}),e.jsx("button",{type:"button",onClick:I,className:"absolute top-2 left-2 bg-red-500 text-white rounded-full p-1 hover:bg-red-600",children:e.jsx(R,{className:"h-4 w-4"})})]}):e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("input",{type:"file",accept:"image/*",onChange:B,className:"hidden",id:"check-image-input"}),e.jsxs("label",{htmlFor:"check-image-input",className:"cursor-pointer bg-[#58d2c8] text-white px-4 py-2 rounded-lg hover:bg-[#4AB8B3] transition-colors flex items-center gap-2",children:[e.jsx(K,{className:"w-4 h-4"}),"رفع صورة الشيك"]})]}),e.jsx("p",{className:"text-xs text-gray-500",children:"الحد الأقصى: 10MB"})]})]})]})})]}),e.jsxs(x,{className:"p-6 mb-6",children:[e.jsx(h,{children:e.jsx(u,{children:"ملاحظات (اختياري)"})}),e.jsx(g,{children:e.jsx("textarea",{value:t.data.notes,onChange:a=>t.setData("notes",a.target.value),rows:4,className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#58d2c8] focus:border-transparent resize-none",placeholder:"أدخل أي ملاحظات إضافية..."})})]}),e.jsxs("div",{className:"flex items-center justify-end gap-4",children:[e.jsx(S,{type:"button",variant:"ghost",onClick:()=>b.visit("/payments"),children:"إلغاء"}),e.jsxs(S,{type:"submit",disabled:t.processing||!s,className:"bg-[#58d2c8] hover:bg-[#4AB8B3] text-white flex items-center gap-2",children:[e.jsx(V,{className:"h-4 w-4"}),t.processing?"جاري الحفظ...":"حفظ الدفعة"]})]})]})]})]})}export{xe as default};
